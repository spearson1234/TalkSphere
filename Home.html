<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For My Dearest Lover</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@300;500&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        body {
            background-color: #000;
            color: white;
            font-family: 'Quicksand', sans-serif;
            overflow: hidden;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .fade-in { animation: fadeIn 0.8s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #ff4d6d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .valentine-bg { background: radial-gradient(circle, #2d0a10 0%, #000000 100%); }

        .btn-love { 
            background: linear-gradient(135deg, #ff4d6d 0%, #ff1744 100%); 
            transition: all 0.3s; 
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 77, 109, 0.3);
        }
        .btn-love:hover { 
            transform: scale(1.05); 
            box-shadow: 0 6px 25px rgba(255, 77, 109, 0.5); 
        }
        .btn-love:active {
            transform: scale(0.98);
        }

        #profilePanel { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
        #profilePanel.open { transform: translateX(0); }

        .ticket {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #b8860b 100%);
            color: #000;
            padding: 2rem;
            border-radius: 1rem;
            position: relative;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
            font-family: 'Dancing Script', cursive;
            border: 3px dashed #b8860b;
        }
        .ticket::before, .ticket::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40px;
            height: 40px;
            background: #000;
            border-radius: 50%;
            transform: translateY(-50%);
        }
        .ticket::before { left: -20px; }
        .ticket::after { right: -20px; }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(24px); }

        .chat-container {
            display: flex; flex-direction: column; height: 100vh; width: 100vw;
            background: #000; position: fixed; top: 0; left: 0; z-index: 150;
        }
        .message-bubble {
            max-width: 80%; padding: 10px 14px; border-radius: 18px; margin-bottom: 8px;
            word-wrap: break-word; font-size: 15px; position: relative;
            animation: messagePop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes messagePop {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .msg-me { 
            background: linear-gradient(135deg, #ff4d6d 0%, #ff1744 100%); 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; 
            margin-right: 8px;
            box-shadow: 0 2px 8px rgba(255, 77, 109, 0.3);
        }
        .msg-them { 
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%); 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tick-container { 
            font-size: 10px; 
            margin-left: 6px; 
            position: absolute; 
            bottom: 4px; 
            right: 8px; 
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .msg-me .tick-container { color: #fff; }
        .msg-them .tick-container { color: #888; display: none; }

        .voice-bubble { display: flex; flex-direction: column; gap: 4px; min-width: 180px; padding-bottom: 12px; }
        .audio-wave-row { display: flex; align-items: center; gap: 10px; }
        .audio-wave { 
            flex: 1; 
            height: 24px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 0 8px;
        }
        .wave-bar {
            width: 3px;
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
            animation: waveAnim 1s ease-in-out infinite;
        }
        @keyframes waveAnim {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }
        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        .reply-preview { 
            background: rgba(0,0,0,0.3); 
            border-left: 3px solid currentColor; 
            padding: 6px 10px; 
            border-radius: 6px; 
            margin-bottom: 6px; 
            font-size: 11px;
            opacity: 0.9;
        }
        .msg-me .reply-preview { border-left-color: rgba(255,255,255,0.6); }
        .msg-them .reply-preview { border-left-color: #ff4d6d; }

        .reply-btn { 
            position: absolute; 
            right: -35px; 
            top: 50%; 
            transform: translateY(-50%); 
            opacity: 0; 
            transition: opacity 0.2s; 
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
        }
        .message-bubble:hover .reply-btn { opacity: 1; }
        .msg-them .reply-btn { right: auto; left: -35px; }

        .heart {
            position: absolute;
            color: #ff4d6d;
            font-size: 20px;
            animation: floatUp 4s linear infinite;
            opacity: 0;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg) scale(1); opacity: 1; }
            50% { opacity: 0.8; }
            100% { transform: translateY(-10vh) rotate(360deg) scale(1.5); opacity: 0; }
        }

        #notificationToast {
            position: fixed; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff4d6d 0%, #ff1744 100%); 
            color: white; 
            padding: 14px 28px; 
            border-radius: 30px;
            z-index: 999; 
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            box-shadow: 0 6px 20px rgba(255, 77, 109, 0.5);
            font-weight: bold; 
            width: 90%; 
            max-width: 400px; 
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
        }
        #notificationToast.show { top: 20px; }
        
        .recording-pulse { 
            animation: pulseRed 1.5s ease-in-out infinite; 
        }
        @keyframes pulseRed { 
            0%, 100% { 
                background: #ff4d6d; 
                box-shadow: 0 0 0 0px rgba(255, 77, 109, 0.7); 
            }
            50% { 
                background: #ff1744; 
                box-shadow: 0 0 0 15px rgba(255, 77, 109, 0); 
            }
        }

        #replyBar { 
            background: rgba(40, 40, 40, 0.95); 
            border-top: 1px solid rgba(255,77,109,0.3);
            padding: 10px 16px; 
            display: none; 
            align-items: center; 
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            animation: typingAnim 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingAnim {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-6px); }
        }

        .timestamp {
            font-size: 9px;
            opacity: 0.5;
            margin-right: 20px;
        }

        /* Improved mobile responsiveness */
        @media (max-width: 640px) {
            .ticket { padding: 1.5rem; font-size: 0.9rem; }
            .message-bubble { max-width: 85%; font-size: 14px; }
            .voice-bubble { min-width: 150px; }
        }

        /* Loading animation improvements */
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Smooth scrollbar for chat */
        #chatList::-webkit-scrollbar { width: 6px; }
        #chatList::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        #chatList::-webkit-scrollbar-thumb { 
            background: rgba(255,77,109,0.3); 
            border-radius: 3px; 
        }
        #chatList::-webkit-scrollbar-thumb:hover { background: rgba(255,77,109,0.5); }
    </style>
</head>
<body class="valentine-bg">

    <div id="heartsContainer"></div>
    <div id="notificationToast">New Secret Message! ‚ù§Ô∏è</div>

    <!-- Global App Buttons -->
    <div id="actionButtons" class="hidden fixed top-6 right-6 z-[110] flex gap-3">
        <button onclick="openChat()" class="relative bg-white/10 p-3 rounded-full border border-white/20 backdrop-blur-md hover:bg-white/20 transition-all text-pink-400 hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            <div id="unreadBadge" class="hidden absolute -top-1 -right-1 bg-pink-600 text-[10px] min-w-[18px] h-[18px] rounded-full flex items-center justify-center text-white border-2 border-black font-bold animate-pulse"></div>
        </button>
        <button onclick="toggleProfile()" class="bg-white/10 p-3 rounded-full border border-white/20 backdrop-blur-md hover:bg-white/20 transition-all text-pink-400 hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </button>
    </div>

    <!-- Profile Slide Panel -->
    <div id="profilePanel" class="fixed top-0 right-0 h-full w-80 bg-zinc-900/95 border-l border-white/10 backdrop-blur-xl p-8 flex flex-col">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-xl font-bold text-pink-500 tracking-tight">Identity Details</h2>
            <button onclick="toggleProfile()" class="text-white/40 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-6">
            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                <p class="text-[10px] uppercase tracking-widest text-white/30 mb-1">Authenticated As</p>
                <p id="profileName" class="text-lg font-bold text-white uppercase tracking-widest">---</p>
            </div>
            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                <p class="text-[10px] uppercase tracking-widest text-white/30 mb-1">Access Tier</p>
                <p id="profileTier" class="text-sm font-medium text-pink-400 uppercase tracking-widest">Lover Access</p>
            </div>
            <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                <p class="text-[10px] uppercase tracking-widest text-white/30 mb-1">Login Time</p>
                <p id="profileTime" class="text-sm font-medium text-white">---</p>
            </div>
        </div>
        <div class="mt-auto pt-10 border-t border-white/10 text-center">
            <button onclick="location.reload()" class="w-full py-3 rounded-xl border border-white/10 text-white/40 text-xs font-bold uppercase tracking-widest hover:bg-white/5 transition-all">Sign Out</button>
        </div>
    </div>

    <!-- System Shutdown Overlay -->
    <div id="shutdownOverlay" class="hidden fixed inset-0 z-[200] bg-black flex flex-col items-center justify-center text-center px-6">
        <div class="text-pink-600 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
        </div>
        <h1 class="text-3xl font-bold mb-4">System Offline</h1>
        <p class="text-white/60 max-w-sm mb-8">The secret letter is currently unavailable. Please check back later.</p>
        <button onclick="showAdminLogin()" class="text-white/5 hover:text-white/20 transition-colors text-[10px] tracking-widest uppercase">Admin Login</button>
    </div>

    <!-- Security Check -->
    <div id="securityCheck" class="flex flex-col items-center text-center px-6 w-full max-w-md">
        <div class="mb-6 text-pink-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></div>
        <h2 class="text-xl mb-6 font-medium tracking-tight">Confirmation required to enter this Secret Letter.</h2>
        <input type="text" id="nameInput" placeholder="Enter your name..." class="bg-white/10 border-2 border-white/20 px-6 py-3 rounded-full text-center text-white focus:outline-none focus:border-pink-500/50 mb-4 w-full" onkeypress="if(event.key==='Enter') verifyName()">
        <button onclick="verifyName()" class="btn-love px-10 py-3 rounded-full font-bold w-full">Verify Identity</button>
    </div>

    <!-- Main Content Steps -->
    <div id="loadingScreen" class="hidden flex flex-col items-center">
        <div class="spinner mb-4"></div>
        <h1 class="text-2xl font-light tracking-widest text-pink-200 uppercase loading-pulse">Verifying..</h1>
    </div>

    <!-- Step 1: Initial Question -->
    <div id="step1" class="hidden flex flex-col items-center text-center px-6 max-w-2xl">
        <h2 class="text-4xl md:text-5xl font-bold mb-10 leading-tight">Do you know why I love you soooo much?</h2>
        <div class="flex gap-4 md:gap-8">
            <button onclick="handleYes1()" class="btn-love px-6 md:px-10 py-4 rounded-full text-xl md:text-2xl font-bold shadow-xl">Yes ‚ù§Ô∏è</button>
            <button onmouseover="handleNo(this)" ontouchstart="handleNo(this)" onclick="handleNo(this)" class="bg-white/10 px-6 md:px-10 py-4 rounded-full text-xl md:text-2xl font-bold transition-all hover:bg-white/20">No üñ§</button>
        </div>
    </div>

    <!-- Step 2: The Ticket -->
    <div id="stepTicket" class="hidden flex flex-col items-center text-center px-6">
        <div class="ticket fade-in max-w-md">
            <h3 class="text-3xl font-bold mb-2">‚ú® Golden Ticket ‚ú®</h3>
            <p class="text-xl mb-4 italic">One Special Night Out Together</p>
            <div class="border-t-2 border-black/20 pt-4 mt-4">
                <p class="text-sm font-bold uppercase tracking-widest mb-2">Valid for:</p>
                <p class="text-base">Dinner, Movie, or Any Adventure</p>
            </div>
            <div class="border-t-2 border-black/20 pt-4 mt-4 text-sm font-bold uppercase tracking-widest">
                To: My Brooke | From: Your Smithy
            </div>
        </div>
        <button onclick="handleTicketNext()" class="mt-12 btn-love px-10 py-3 rounded-full font-bold shadow-xl">Open Letter ‚úâÔ∏è</button>
    </div>

    <!-- Step 3: The Full Letter -->
    <div id="stepLetter" class="hidden flex-col items-center text-center px-8 overflow-y-auto h-screen py-20">
        <div class="max-w-2xl bg-white/5 p-8 md:p-10 rounded-3xl border border-white/10 backdrop-blur-md shadow-2xl">
            <h2 class="text-4xl md:text-5xl font-bold text-pink-500 mb-8 font-['Dancing_Script']">My Dearest Brooke,</h2>
            <div class="space-y-6 text-base md:text-lg text-white/90 leading-relaxed text-left">
                <p>I wanted to write you something that shows just how much you mean to me. Every single day, I find new reasons to fall in love with you all over again.</p>
                <p>The way you smile, the way you laugh, and even the small moments we share together‚Äîthey are the highlights of my life. You are my best friend, my rock, and my everything.</p>
                <p>I am so incredibly lucky to have you by my side. Thank you for being the amazing person you are.</p>
                <p>I love you more than words can ever describe. ‚ù§Ô∏è</p>
            </div>
            <div class="mt-10 text-right font-['Dancing_Script'] text-3xl text-pink-400">
                Forever Yours,<br>Smithy
            </div>
        </div>
        <button onclick="handleValentine()" class="mt-12 btn-love px-10 py-3 rounded-full font-bold shadow-xl">Happy Valentine's ‚ù§Ô∏è</button>
    </div>

    <!-- Step 4: Final Screen -->
    <div id="stepValentine" class="hidden flex flex-col items-center text-center px-8">
        <div class="mb-6">
            <svg viewBox="0 0 32 32" class="w-24 h-24 fill-pink-600 animate-pulse"><path d="M16 28.5L14.1 26.6C7.2 20.4 3 16.5 3 11.5 3 7.4 6.4 4 10.5 4 12.8 4 15 5.1 16.5 6.8 18 5.1 20.2 4 22.5 4 26.6 4 30 7.4 30 11.5 30 16.5 25.8 20.4 18.9 26.6L16 28.5Z"/></svg>
        </div>
        <h2 class="text-5xl md:text-6xl font-bold text-pink-400 mb-6 font-['Dancing_Script'] tracking-wider">Happy Valentine's!</h2>
        <p class="text-white/60 text-lg md:text-xl mb-4">I love you more than everything else in this world.</p>
        <p class="text-white/40 text-sm">- Smithy ‚ù§Ô∏è</p>
    </div>

    <!-- Admin Logic UI -->
    <div id="adminPasswordCheck" class="hidden flex flex-col items-center text-center px-6 max-w-sm">
        <h2 class="text-xl mb-6 font-bold text-pink-400 uppercase tracking-widest">Admin Authorization</h2>
        <input type="password" id="adminPin" placeholder="ENTER PIN" class="bg-white/10 border-2 border-white/20 px-6 py-3 rounded-full text-center text-white tracking-widest mb-4 w-full" onkeypress="if(event.key==='Enter') verifyAdminPin()">
        <button onclick="verifyAdminPin()" class="btn-love w-full py-3 rounded-full font-bold">Log In</button>
        <p id="adminError" class="hidden text-red-400 text-sm mt-3">‚ùå Invalid PIN</p>
    </div>

    <div id="adminPanel" class="hidden flex flex-col items-center text-center px-6 w-full max-w-3xl">
        <div class="bg-white/10 p-6 md:p-10 rounded-3xl border border-white/20 backdrop-blur-xl w-full">
            <div class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
                <h1 class="text-2xl font-bold text-pink-400">Admin Dashboard</h1>
                <div class="flex items-center gap-3 bg-black/40 px-4 py-2 rounded-2xl border border-white/10">
                    <span id="statusLabel" class="text-xs font-bold text-green-400 uppercase tracking-widest">System Online</span>
                    <label class="switch"><input type="checkbox" id="systemToggle" checked onchange="handleSystemToggle(this)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                <div class="bg-white/5 p-5 rounded-2xl border border-white/5">
                    <h3 class="text-pink-300 font-bold text-sm mb-1 uppercase tracking-widest">Control Center</h3>
                    <p class="text-xs opacity-60">Master Switch for User Access</p>
                </div>
                <div class="bg-white/5 p-5 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/10 transition-all" onclick="openChat()">
                    <h3 class="text-pink-300 font-bold text-sm mb-1 uppercase tracking-widest flex items-center gap-2">
                        Live Chat
                        <span id="adminUnreadBadge" class="hidden bg-pink-600 text-[9px] px-1.5 py-0.5 rounded-full">New</span>
                    </h3>
                    <p class="text-xs opacity-60">Open Secret Chat Box</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Chat UI -->
    <div id="chatUI" class="hidden chat-container">
        <div class="p-6 border-b border-white/10 flex items-center gap-4 bg-black/50 backdrop-blur-md">
            <button onclick="closeChat()" class="text-white/50 hover:text-white transition-all hover:scale-110">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div class="flex-1">
                <h2 id="chatWithTitle" class="text-lg font-bold">Secure Chat</h2>
                <div class="flex items-center gap-1.5">
                    <div id="onlinePulse" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span id="lastSeenDisplay" class="text-[10px] uppercase tracking-widest text-white/40">Checking status...</span>
                </div>
            </div>
        </div>
        <div id="chatList" class="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col relative space-y-2">
            <div id="chatOfflineNotice" class="hidden absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm z-10">
                <div class="text-center">
                    <p class="text-white/30 text-xl font-bold uppercase tracking-[0.2em] mb-2">System Paused</p>
                    <p class="text-white/20 text-sm">Admin has disabled chat access</p>
                </div>
            </div>
            <div id="typingIndicator" class="hidden message-bubble msg-them typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <!-- Reply Bar -->
        <div id="replyBar">
            <div class="flex flex-col">
                <span class="text-[10px] text-pink-400 font-bold uppercase">Replying to Voice Note</span>
                <span id="replyText" class="text-xs text-white/60 italic truncate max-w-[200px]">Voice message</span>
            </div>
            <button onclick="cancelReply()" class="text-white/40 hover:text-white transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <!-- Input Bar -->
        <div class="p-4 md:p-6 border-t border-white/10 bg-black/80 flex items-end gap-2 md:gap-3">
            <button id="voiceBtn" class="bg-white/5 p-3 md:p-4 rounded-2xl hover:bg-white/10 text-pink-500 transition-all hover:scale-105">
                <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
            </button>
            <textarea id="chatInput" placeholder="Message..." rows="1" class="flex-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-white focus:outline-none focus:border-pink-500 resize-none max-h-32" onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
            <button id="chatSendBtn" onclick="sendMessage()" class="bg-pink-600 p-3 md:p-4 rounded-2xl hover:bg-pink-500 transition-all hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDlcI_JtmeNMcJxvjvUER5W1ROCH0uOfn4",
            authDomain: "test-83d1d.firebaseapp.com",
            databaseURL: "https://test-83d1d-default-rtdb.firebaseio.com",
            projectId: "test-83d1d",
            storageBucket: "test-83d1d.firebasestorage.app",
            messagingSenderId: "1060438880379",
            appId: "1:1060438880379:web:a22b03441ea97c16b3b2de"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const systemRef = database.ref('system_status');
        const chatRef = database.ref('private_chat');
        const presenceRef = database.ref('presence');

        let isSystemActive = true;
        let currentUserRole = null;
        let currentUserName = "";
        let unreadCount = 0;
        let isChatOpen = false;
        let mediaRecorder;
        let audioChunks = [];
        let replyingToId = null;
        let loginTime = null;

        // Background Hearts
        function createHeart() {
            const container = document.getElementById('heartsContainer');
            const heart = document.createElement('div');
            heart.innerHTML = '‚ù§Ô∏è';
            heart.className = 'heart';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.animationDuration = (Math.random() * 2 + 3) + 's';
            heart.style.fontSize = (Math.random() * 10 + 15) + 'px';
            container.appendChild(heart);
            setTimeout(() => heart.remove(), 5000);
        }
        setInterval(createHeart, 600);

        // Initialize system status listener
        systemRef.on('value', (s) => {
            const data = s.val();
            if (data !== null) {
                isSystemActive = data.active !== false;
                updateSystemUI(isSystemActive);
                const toggle = document.getElementById('systemToggle');
                if (toggle) toggle.checked = isSystemActive;
            }
        });

        function updatePresence() {
            if (!currentUserName) return;
            presenceRef.child(currentUserName).set({
                last_seen: Date.now(),
                online: true
            });
            presenceRef.child(currentUserName).onDisconnect().set({
                last_seen: Date.now(),
                online: false
            });
        }

        function monitorOtherUser() {
            const otherUser = currentUserName === "Smithy" ? "Brooke" : "Smithy";
            document.getElementById('chatWithTitle').innerText = `Chat with ${otherUser}`;
            
            presenceRef.child(otherUser).on('value', (s) => {
                const data = s.val();
                const display = document.getElementById('lastSeenDisplay');
                const pulse = document.getElementById('onlinePulse');
                
                if (data) {
                    const isOnline = data.online && (Date.now() - data.last_seen < 15000);
                    if (isOnline) {
                        display.innerText = "Online Now";
                        pulse.classList.remove('bg-gray-500');
                        pulse.classList.add('bg-green-500', 'animate-pulse');
                    } else {
                        const date = new Date(data.last_seen);
                        const hours = date.getHours();
                        const minutes = date.getMinutes().toString().padStart(2, '0');
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const displayHours = hours % 12 || 12;
                        display.innerText = `Last seen: ${displayHours}:${minutes} ${ampm}`;
                        pulse.classList.remove('bg-green-500', 'animate-pulse');
                        pulse.classList.add('bg-gray-500');
                    }
                } else {
                    display.innerText = "Offline";
                    pulse.classList.remove('bg-green-500', 'animate-pulse');
                    pulse.classList.add('bg-gray-500');
                }
            });
        }

        function updateSystemUI(active) {
            const overlay = document.getElementById('shutdownOverlay');
            const chatOverlay = document.getElementById('chatOfflineNotice');
            
            if (currentUserRole !== 'admin') {
                if (!active) {
                    overlay.classList.remove('hidden');
                    if (isChatOpen) chatOverlay.classList.remove('hidden');
                } else {
                    overlay.classList.add('hidden');
                    chatOverlay.classList.add('hidden');
                }
            }
            
            const label = document.getElementById('statusLabel');
            if (label) {
                label.innerText = active ? "System Online" : "System Offline";
                label.className = active 
                    ? "text-xs font-bold text-green-400 uppercase tracking-widest" 
                    : "text-xs font-bold text-red-400 uppercase tracking-widest";
            }
        }

        function verifyName() {
            const val = document.getElementById('nameInput').value.trim().toLowerCase();
            if (val === 'smith' || val === 'smithy') {
                currentUserName = "Smithy";
                transition('securityCheck', 'adminPasswordCheck');
            } else if (val === 'brooke') {
                if (!isSystemActive) {
                    document.getElementById('shutdownOverlay').classList.remove('hidden');
                    return;
                }
                currentUserName = "Brooke";
                currentUserRole = 'user';
                loginTime = new Date();
                onAuthenticated();
                transition('securityCheck', 'loadingScreen');
                setTimeout(() => {
                    document.getElementById('actionButtons').classList.remove('hidden');
                    transition('loadingScreen', 'step1');
                }, 2000);
            } else {
                const input = document.getElementById('nameInput');
                input.classList.add('border-red-500');
                input.value = '';
                input.placeholder = 'Invalid name. Try again...';
                setTimeout(() => {
                    input.classList.remove('border-red-500');
                    input.placeholder = 'Enter your name...';
                }, 2000);
            }
        }

        function onAuthenticated() {
            updatePresence();
            setInterval(updatePresence, 5000);
            monitorOtherUser();
            initVoiceRecording();
            updateProfilePanel();
        }

        function updateProfilePanel() {
            document.getElementById('profileName').innerText = currentUserName;
            if (loginTime) {
                const hours = loginTime.getHours();
                const minutes = loginTime.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                document.getElementById('profileTime').innerText = `${displayHours}:${minutes} ${ampm}`;
            }
        }

        function verifyAdminPin() {
            const pin = document.getElementById('adminPin').value;
            if (pin === '2009') {
                currentUserRole = 'admin';
                loginTime = new Date();
                onAuthenticated();
                document.getElementById('actionButtons').classList.remove('hidden');
                transition('adminPasswordCheck', 'adminPanel');
            } else {
                const error = document.getElementById('adminError');
                error.classList.remove('hidden');
                document.getElementById('adminPin').value = '';
                document.getElementById('adminPin').classList.add('border-red-500');
                setTimeout(() => {
                    error.classList.add('hidden');
                    document.getElementById('adminPin').classList.remove('border-red-500');
                }, 2000);
            }
        }

        function showAdminLogin() { transition('shutdownOverlay', 'adminPasswordCheck'); }
        
        function handleNo(btn) {
            if (window.innerWidth <= 768) {
                // Mobile: just shake the button
                btn.classList.add('animate-bounce');
                setTimeout(() => btn.classList.remove('animate-bounce'), 500);
            } else {
                // Desktop: move it around
                const maxX = window.innerWidth - btn.offsetWidth - 100;
                const maxY = window.innerHeight - btn.offsetHeight - 100;
                btn.style.position = 'absolute';
                btn.style.left = Math.random() * maxX + 'px';
                btn.style.top = Math.random() * maxY + 'px';
            }
        }
        
        function handleYes1() { transition('step1', 'stepTicket'); }
        function handleTicketNext() { transition('stepTicket', 'stepLetter'); }
        function handleValentine() { transition('stepLetter', 'stepValentine'); }
        
        function toggleProfile() { 
            document.getElementById('profilePanel').classList.toggle('open'); 
            updateProfilePanel();
        }

        function transition(f, t) {
            document.getElementById(f).classList.add('hidden');
            const to = document.getElementById(t);
            to.classList.remove('hidden');
            if(t !== 'stepLetter' && t !== 'adminPanel') to.classList.add('flex');
            to.classList.add('fade-in');
        }

        function showNotification(msg) {
            if (isChatOpen) return;
            const toast = document.getElementById('notificationToast');
            const senderName = msg.sender === currentUserName ? "You" : msg.sender;
            
            if (msg.type === 'voice') {
                toast.innerText = `${senderName === "You" ? "New" : senderName + " sent a"} voice note üé§`;
            } else {
                toast.innerText = `${senderName}: ${msg.text.substring(0, 30)}${msg.text.length > 30 ? '...' : ''}`;
            }
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
            
            if (msg.sender !== currentUserName) {
                unreadCount++;
                const badge = document.getElementById('unreadBadge');
                badge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
                
                if (currentUserRole === 'admin') {
                    document.getElementById('adminUnreadBadge').classList.remove('hidden');
                }
            }
        }

        function openChat() {
            isChatOpen = true;
            unreadCount = 0;
            document.getElementById('unreadBadge').classList.add('hidden');
            document.getElementById('adminUnreadBadge').classList.add('hidden');
            document.getElementById('chatUI').classList.remove('hidden');
            loadMessages();
        }
        
        function closeChat() {
            isChatOpen = false;
            document.getElementById('chatUI').classList.add('hidden');
        }

        function startReply(id, sender) {
            replyingToId = id;
            document.getElementById('replyBar').style.display = 'flex';
            document.getElementById('replyText').innerText = `${sender}'s voice note`;
        }

        function cancelReply() {
            replyingToId = null;
            document.getElementById('replyBar').style.display = 'none';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes} ${ampm}`;
        }

        function loadMessages() {
            chatRef.off();
            chatRef.on('value', (snapshot) => {
                const list = document.getElementById('chatList');
                const data = snapshot.val();
                
                // Keep the offline notice and typing indicator elements
                const offlineNotice = document.getElementById('chatOfflineNotice');
                const typingIndicator = document.getElementById('typingIndicator');
                list.innerHTML = '';
                list.appendChild(offlineNotice);
                
                if (data) {
                    Object.entries(data).forEach(([id, msg]) => {
                        const div = document.createElement('div');
                        div.className = `message-bubble ${msg.sender === currentUserName ? 'msg-me' : 'msg-them'} fade-in`;
                        
                        let content = '';
                        if (msg.replyTo) {
                            content += `<div class="reply-preview">‚Ü© Replying to voice note</div>`;
                        }

                        if (msg.type === 'voice') {
                            content += `
                                <div class="voice-bubble">
                                    <div class="audio-wave-row">
                                        <button onclick="playVoice('${msg.audio}')" class="text-white hover:scale-110 transition-transform">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                        </button>
                                        <div class="audio-wave">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-[9px] opacity-60">Voice Note</span>
                                        <span class="text-[9px] opacity-40">${formatTime(msg.timestamp)}</span>
                                    </div>
                                </div>
                            `;
                            
                            if (msg.sender !== currentUserName) {
                                content += `<button onclick="startReply('${id}', '${msg.sender}')" class="reply-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                    </svg>
                                </button>`;
                            }
                        } else {
                            content += `<span>${msg.text}</span>`;
                            content += `<span class="timestamp">${formatTime(msg.timestamp)}</span>`;
                        }

                        content += `<div class="tick-container">‚úì‚úì</div>`;
                        div.innerHTML = content;
                        list.appendChild(div);

                        if (msg.sender !== currentUserName && !msg.readTriggered) {
                            showNotification(msg);
                            chatRef.child(id).update({ readTriggered: true });
                        }
                    });
                }
                
                list.appendChild(typingIndicator);
                list.scrollTop = list.scrollHeight;
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (text && (isSystemActive || currentUserRole === 'admin')) {
                chatRef.push({ 
                    sender: currentUserName, 
                    text: text, 
                    type: 'text', 
                    timestamp: Date.now(),
                    replyTo: replyingToId 
                });
                input.value = "";
                input.style.height = 'auto';
                cancelReply();
            }
        }

        function initVoiceRecording() {
            const btn = document.getElementById('voiceBtn');
            let isRecording = false;
            let longPressTimer;

            const startRecording = async () => {
                if (isRecording || (!isSystemActive && currentUserRole !== 'admin')) return;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        stream.getTracks().forEach(track => track.stop());
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/webm' }));
                        reader.onloadend = () => {
                            chatRef.push({
                                sender: currentUserName,
                                audio: reader.result,
                                type: 'voice',
                                timestamp: Date.now(),
                                replyTo: replyingToId
                            });
                            cancelReply();
                        };
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording-pulse');
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Could not access microphone. Please check permissions.');
                }
            };

            const stopRecording = () => {
                if (!isRecording) return;
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording-pulse');
            };

            // Touch events for mobile
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                longPressTimer = setTimeout(startRecording, 200);
            });

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearTimeout(longPressTimer);
                stopRecording();
            });

            btn.addEventListener('touchcancel', () => {
                clearTimeout(longPressTimer);
                stopRecording();
            });

            // Mouse events for desktop
            btn.addEventListener('mousedown', () => {
                longPressTimer = setTimeout(startRecording, 200);
            });

            btn.addEventListener('mouseup', () => {
                clearTimeout(longPressTimer);
                stopRecording();
            });

            btn.addEventListener('mouseleave', () => {
                clearTimeout(longPressTimer);
                stopRecording();
            });
        }

        function playVoice(b64) {
            const audio = new Audio(b64);
            audio.play().catch(err => console.error('Error playing audio:', err));
        }

        function handleSystemToggle(cb) {
            systemRef.update({ active: cb.checked });
        }

        // Auto-resize textarea
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('chatInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 128) + 'px';
                });
            }
        });
    </script>
</body>
</html>
